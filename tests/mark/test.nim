{.experimental: "strictDefs".}
{.experimental: "strictFuncs".}
{.experimental: "views".}

import std/[unittest]
import ../../src/pon2/core/[cell, field, mark, nazopuyo, placement, step]
import ../../src/pon2/private/[results2]

func mark2[F: TsuField or WaterField](
    nazo: NazoPuyo[F], plcmts: varargs[Placement]
): MarkResult =
  var nazo2 = nazo
  for i, plcmt in plcmts:
    nazo2.puyoPuyo.steps[i].optPlacement.ok plcmt

  nazo2.mark

func mark2[F: TsuField or WaterField](
    nazo: NazoPuyo[F], optPlcmts: varargs[OptPlacement]
): MarkResult =
  var nazo2 = nazo
  for i, optPlcmt in optPlcmts:
    nazo2.puyoPuyo.steps[i].optPlacement = optPlcmt

  nazo2.mark

block: # mark
  block: # Clear
    let nazo = parseNazoPuyo[TsuField](
      """
ぷよ全て消すべし
======
......
......
......
......
......
......
......
......
......
......
......
bb.yyy
yy.bbb
------
by|
by|"""
    ).expect

    check nazo.mark2(Left3, Down2) == Accept
    check nazo.mark2(OptPlacement.ok Left3, NonePlacement) == WrongAnswer

  block: # AccColor
    let nazo = parseNazoPuyo[TsuField](
      """
3色消すべし
======
......
......
......
......
......
......
......
......
......
......
......
...gbr
.bgbrr
------
bg|
rg|"""
    ).expect

    check nazo.mark2(Down2, Left5) == Accept
    check nazo.mark2(Left3, Left5) == WrongAnswer

  block: # AccColorMore
    let nazo = parseNazoPuyo[TsuField](
      """
3色以上消すべし
======
......
......
......
......
......
......
......
......
......
......
......
...gbr
.bgbrr
------
bg|
rg|"""
    ).expect

    check nazo.mark2(Down2, Left5) == Accept
    check nazo.mark2(Left3, Left5) == WrongAnswer

  block: # AccCnt
    let nazo = parseNazoPuyo[TsuField](
      """
ぷよ18個消すべし
======
......
......
......
......
......
......
......
......
..b...
..y...
ggg...
ooo...
ooobbb
------
yy|
yg|"""
    ).expect

    check nazo.mark2(Up0, Down1) == Accept
    check nazo.mark2(Right3, Down3) == WrongAnswer

  block: # AccCntMore
    let nazo = parseNazoPuyo[TsuField](
      """
ぷよ18個以上消すべし
======
......
......
......
......
......
......
......
......
..b...
..y...
ggg...
ooo...
ooobbb
------
yy|
yg|"""
    ).expect

    check nazo.mark2(Up0, Down1) == Accept
    check nazo.mark2(Right3, Down3) == WrongAnswer

  block: # Chain
    let nazo = parseNazoPuyo[WaterField](
      """
3連鎖するべし
======
......
......
......
......
......
~~~~~~
rpor..
.pp...
..y...
..y...
..y...
......
......
......
------
ry|
rp|"""
    ).expect

    check nazo.mark2(Left2, Down1) == Accept
    check nazo.mark2(Down2, Down1) == WrongAnswer

  block: # ChainMore
    let nazo = parseNazoPuyo[WaterField](
      """
3連鎖以上するべし
======
......
......
......
......
......
~~~~~~
rpor..
.pp...
..y...
..y...
..y...
......
......
......
------
ry|
rp|"""
    ).expect

    check nazo.mark2(Left2, Down1) == Accept
    check nazo.mark2(Down2, Down1) == WrongAnswer

  block: # ClearChain
    let nazo = parseNazoPuyo[TsuField](
      """
5連鎖&ぷよ全て消すべし
======
......
......
......
......
......
......
.....r
..y..r
..yy.y
..bbby
..hooo
..ybby
..yrry
------
by|
by|
by|"""
    ).expect

    check nazo.mark2(Up1, Left2, Up4) == Accept
    check nazo.mark2(Down3, Up3, Left4) == WrongAnswer

  block: # ClearChainMore
    let nazo = parseNazoPuyo[TsuField](
      """
5連鎖以上&ぷよ全て消すべし
======
......
......
......
......
......
......
.....r
..y..r
..yy.y
..bbby
..hooo
..ybby
..yrry
------
by|
by|
by|"""
    ).expect

    check nazo.mark2(Up1, Left2, Up4) == Accept
    check nazo.mark2(Down3, Up3, Left4) == WrongAnswer

  block: # Color
    let nazo = parseNazoPuyo[TsuField](
      """
2色同時に消すべし
======
......
......
......
......
......
......
...g..
...po.
...pg.
...pg.
...og.
.o.pp.
.gggp.
------
gp|
gp|"""
    ).expect
    check nazo.mark2(Left5, Down5) == Accept
    check nazo.mark2(Down5, Up4) == WrongAnswer

  block: # ColorMore
    let nazo = parseNazoPuyo[TsuField](
      """
2色以上同時に消すべし
======
......
......
......
......
......
......
...g..
...po.
...pg.
...pg.
...og.
.o.pp.
.gggp.
------
gp|
gp|"""
    ).expect
    check nazo.mark2(Left5, Down5) == Accept
    check nazo.mark2(Down5, Up4) == WrongAnswer

  block: # Cnt
    let nazo = parseNazoPuyo[TsuField](
      """
ぷよ12個同時に消すべし
======
......
......
......
......
......
......
......
......
......
...r..
..rr..
rggb..
rrgbb.
------
rb|
rg|"""
    ).expect
    check nazo.mark2(Down2, Left2) == Accept
    check nazo.mark2(Down5, Down1) == WrongAnswer

  block: # CntMore
    let nazo = parseNazoPuyo[TsuField](
      """
ぷよ12個以上同時に消すべし
======
......
......
......
......
......
......
......
......
......
...r..
..rr..
rggb..
rrgbb.
------
rb|
rg|"""
    ).expect
    check nazo.mark2(Down2, Left2) == Accept
    check nazo.mark2(Down5, Down1) == WrongAnswer

  block: # Place
    let nazo = parseNazoPuyo[TsuField](
      """
ぷよ2箇所同時に消すべし
======
......
......
......
......
......
......
......
......
......
......
....r.
y...y.
yyryy.
------
ry|
ry|"""
    ).expect
    check nazo.mark2(Down3, Left2) == Accept
    check nazo.mark2(Up2, Down3) == WrongAnswer

  block: # PlaceMore
    let nazo = parseNazoPuyo[TsuField](
      """
ぷよ2箇所以上同時に消すべし
======
......
......
......
......
......
......
......
......
......
......
....r.
y...y.
yyryy.
------
ry|
ry|"""
    ).expect
    check nazo.mark2(Down3, Left2) == Accept
    check nazo.mark2(Up2, Down3) == WrongAnswer

  block: # Conn
    let nazo = parseNazoPuyo[TsuField](
      """
ぷよ7連結で消すべし
======
......
......
......
......
......
......
......
......
..o...
grgr..
ggrg..
rrbb..
gggbr.
------
gg|
bg|"""
    ).expect
    check nazo.mark2(Up3, Left4) == Accept
    check nazo.mark2(Up1, Left2) == WrongAnswer

  block: # ConnMore
    let nazo = parseNazoPuyo[TsuField](
      """
ぷよ7連結以上で消すべし
======
......
......
......
......
......
......
......
......
..o...
grgr..
ggrg..
rrbb..
gggbr.
------
gg|
bg|"""
    ).expect
    check nazo.mark2(Up3, Left4) == Accept
    check nazo.mark2(Up1, Left2) == WrongAnswer

  block: # Dead, InvalidMove, SkipMove
    let nazo = parseNazoPuyo[TsuField](
      """
ぷよ全て消すべし
======
......
.....o
.....o
..o..o
..o..o
..o..o
..o..o
..o..o
..o..o
..o..o
..o..o
..o..o
..o..o
------
rg|
by|"""
    ).expect

    check nazo.mark2(Up2) == Dead
    check nazo.mark2(Up5) == InvalidMove
    check nazo.mark2(NonePlacement, OptPlacement.ok Up3) == SkipMove

  block: # NotSupport
    let nazo = parseNazoPuyo[TsuField](
      """
おじゃまぷよ2箇所以上同時に消すべし
======
......
......
......
......
......
......
......
......
......
......
....r.
y...y.
yyryy.
------
ry|
ry|"""
    ).expect

    check nazo.mark2(NonePlacement) == NotSupport

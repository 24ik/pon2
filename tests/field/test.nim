{.push raises: [].}
{.experimental: "strictDefs".}
{.experimental: "strictFuncs".}
{.experimental: "views".}

import std/[sugar, unittest]
import
  ../../src/pon2/core/
    [cell, common, field, fqdn, moveresult, pair, placement, popresult, rule, step]
import ../../src/pon2/private/[arrayutils, strutils]
import ../../src/pon2/private/core/[binaryfield]

proc toBinaryField(str: string): BinaryField =
  ## Returns the binary field converted from the string representation.
  let strs = str.split "\n"

  var cellArray {.noinit.}: array[Row, array[Col, bool]]
  for row in Row:
    for col in Col:
      cellArray[row][col] = strs[row.ord][col.ord] == 'x'

  return cellArray.toBinaryField

func toField(str: string): Field =
  ## Returns the Tsu field converted from the string representation.
  str.parseField.unsafeValue

# ------------------------------------------------
# Constructor
# ------------------------------------------------

block: # init
  check Field.init(Rule.Tsu) ==
    """
[通]
......
......
......
......
......
......
......
......
......
......
......
......
......""".toField
  check Field.init(Spinner) ==
    """
[だいかいてん]
......
......
......
......
......
......
......
......
......
......
......
......
......""".toField
  check Field.init(CrossSpinner) ==
    """
[クロスかいてん]
......
......
......
......
......
......
......
......
......
......
......
......
......""".toField
  check Field.init(Rule.Water) ==
    """
[すいちゅう]
......
......
......
......
......
~~~~~~
......
......
......
......
......
......
......
......""".toField

  check Field.init == Field.init Rule.Tsu

# ------------------------------------------------
# Property
# ------------------------------------------------

block: # isDead
  check not """
[通]
oooooo
oo.ooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo""".toField.isDead
  check """
[通]
......
..o...
......
......
......
......
......
......
......
......
......
......
......""".toField.isDead

  check not """
[だいかいてん]
oooooo
oo..oo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo""".toField.isDead
  check """
[だいかいてん]
......
...o..
......
......
......
......
......
......
......
......
......
......
......""".toField.isDead

  check not """
[クロスかいてん]
oooooo
oo..oo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo
oooooo""".toField.isDead
  check """
[クロスかいてん]
......
..o...
......
......
......
......
......
......
......
......
......
......
......""".toField.isDead

  check not """
[すいちゅう]
hhhhhh
hhhhhh
hhhhhh
hhhhhh
......
~~~~~~
hhhhhh
hhhhhh
hhhhhh
hhhhhh
hhhhhh
hhhhhh
hhhhhh
hhhhhh""".toField.isDead
  check """
[すいちゅう]
......
......
......
......
.....h
~~~~~~
......
......
......
......
......
......
......
......""".toField.isDead

# ------------------------------------------------
# Placement
# ------------------------------------------------

block: # invalidPlacements, validPlacements, validDoublePlacements
  block:
    let field = Field.init
    check field.invalidPlacements == {Placement.None}
    check field.validPlacements == ActualPlacements
    check field.validDoublePlacements == DoublePlacements

  block:
    let field =
      """
[通]
......
.r....
......
......
......
......
......
......
......
......
......
......
......""".toField
    check field.invalidPlacements ==
      {Placement.None, Up0, Right0, Down0, Up1, Right1, Down1, Left1, Left2}
    check field.validPlacements == {
      Up2, Up3, Up4, Up5, Right2, Right3, Right4, Down2, Down3, Down4, Down5, Left3,
      Left4, Left5,
    }
    check field.validDoublePlacements == {Up2, Up3, Up4, Up5, Right2, Right3, Right4}

  block:
    let field =
      """
[通]
......
.r....
.....o
......
......
......
......
......
......
......
......
......
......""".toField
    check field.invalidPlacements == {Placement.None, Down1}

  block:
    let field =
      """
[だいかいてん]
......
.y.h..
......
......
......
......
......
......
......
......
......
......
......""".toField
    check field.invalidPlacements == {Placement.None, Down1, Down3}

  block:
    let field =
      """
[クロスかいてん]
.r....
.g.b..
......
......
......
......
......
......
......
......
......
......
......""".toField
    check field.invalidPlacements ==
      {Placement.None, Up0, Right0, Down0, Up1, Right1, Down1, Left1, Left2, Down3}

  block:
    let field =
      """
[すいちゅう]
....h.
.p.o..
..r...
......
......
~~~~~~
......
......
......
......
......
......
......
......""".toField
    check field.invalidPlacements ==
      {
        Placement.None, Down1, Right3, Down3, Up4, Right4, Down4, Left4, Up5, Down5,
        Left5,
      }

# ------------------------------------------------
# Indexer
# ------------------------------------------------

block: # `[]`, `[]=`
  var
    fieldT =
      """
[通]
......
.r....
...o..
......
......
......
......
......
......
......
......
......
......""".toField
    fieldW =
      """
[すいちゅう]
....b.
......
......
......
......
~~~~~~
h.....
......
......
......
......
......
......
......""".toField

  check fieldT[Row1, Col1] == Red
  check fieldT[Row0, Col0] == Cell.None
  check fieldW[Row5, Col0] == Hard
  check fieldW[Row1, Col1] == Cell.None

  fieldT[Row2, Col3] = Purple
  check fieldT[Row2, Col3] == Purple

  fieldW[Row0, Col0] = Yellow
  check fieldW[Row0, Col0] == Yellow

# ------------------------------------------------
# Insert / Delete
# ------------------------------------------------

block: # insert, del
  block: # Tsu
    var field =
      """
[通]
g.....
g.....
.b....
......
..r.y.
...ph.
......
......
......
p.....
......
.o....
.o....""".toField

    field.insert Row3, Col0, Red
    check field ==
      """
[通]
g.....
......
.b....
r.....
..r.y.
...ph.
......
......
......
p.....
......
.o....
.o....""".toField

    field.insert Row0, Col5, Green
    check field ==
      """
[通]
g....g
......
.b....
r.....
..r.y.
...ph.
......
......
......
p.....
......
.o....
.o....""".toField

    field.del Row9, Col0
    check field ==
      """
[通]
.....g
g.....
.b....
......
r.r.y.
...ph.
......
......
......
......
......
.o....
.o....""".toField

  block: # Water
    var field =
      """
[すいちゅう]
g.....
g.....
.b....
......
..r.y.
~~~~~~
...ph.
......
......
......
p.....
......
.o....
.o....""".toField

    field.insert Row4, Col0, Red
    check field ==
      """
[すいちゅう]
g.....
......
.b....
......
r.r.y.
~~~~~~
...ph.
......
......
......
p.....
......
.o....
.o....""".toField

    field.insert Row5, Col0, Green
    check field ==
      """
[すいちゅう]
g.....
......
.b....
......
r.r.y.
~~~~~~
g..ph.
......
......
......
......
p.....
.o....
.o....""".toField

    field.insert Row9, Col1, Yellow
    check field ==
      """
[すいちゅう]
g.....
......
.b....
......
r.r.y.
~~~~~~
g..ph.
......
......
......
.y....
p.....
......
.o....""".toField

    field.insert Row4, Col4, Cell.None
    check field ==
      """
[すいちゅう]
g.....
......
.b....
....y.
r.r...
~~~~~~
g..ph.
......
......
......
.y....
p.....
......
.o....""".toField

    field.insert Row8, Col5, Garbage
    check field ==
      """
[すいちゅう]
g.....
......
.b....
....y.
r.r...
~~~~~~
g..ph.
......
......
.....o
.y....
p.....
......
.o....""".toField

    field.del Row4, Col0
    check field ==
      """
[すいちゅう]
......
g.....
.b....
....y.
..r...
~~~~~~
g..ph.
......
......
.....o
.y....
p.....
......
.o....""".toField

    field.del Row5, Col0
    check field ==
      """
[すいちゅう]
......
g.....
.b....
....y.
..r...
~~~~~~
...ph.
......
......
.....o
py....
......
......
.o....""".toField

    field.del Row12, Col5
    check field ==
      """
[すいちゅう]
......
g.....
.b....
....y.
..r...
~~~~~~
...ph.
......
......
.....o
py....
......
......
.o....""".toField

# ------------------------------------------------
# Count
# ------------------------------------------------

block: # cellCount, puyoCount, colorPuyoCount, garbagesCount
  let
    fieldS =
      """
[だいかいてん]
......
......
rr....
.r..gg
....gg
......
..o...
..oo..
...o..
h..o..
......
......
......""".toField
    fieldW =
      """
[すいちゅう]
......
......
pp....
.p..gg
....gg
~~~~~~
......
..o...
..oo..
...o..
h..o..
......
......
......""".toField

  check fieldS.cellCount(Red) == 3
  check fieldS.cellCount(Blue) == 0
  check fieldW.cellCount(Garbage) == 5
  check fieldW.cellCount(Red) == 0

  check fieldS.puyoCount == 13
  check fieldW.puyoCount == 13

  check fieldS.colorPuyoCount == 7
  check fieldW.colorPuyoCount == 7

  check fieldS.garbagesCount == 6
  check fieldW.garbagesCount == 6

# ------------------------------------------------
# Connect - 2
# ------------------------------------------------

block: # connection2, connection2Vertical, connection2Horizontal
  let
    fieldC =
      """
[クロスかいてん]
bbbrry
yggbgy
ygbbgg
yrbyyy
bbrggy
ggrbbb
......
......
......
......
......
.....h
oo...h""".toField
    fieldW =
      """
[すいちゅう]
bbbrry
yggbgy
ygbbgg
yrbyyy
bbrggy
~~~~~~
ggrbbb
......
......
......
......
......
.....h
oo...h""".toField

  check fieldC.connection2 ==
    """
[クロスかいてん]
...rry
.....y
......
......
bbrgg.
ggr...
......
......
......
......
......
......
......""".toField
  check fieldW.connection2 ==
    """
[すいちゅう]
...rry
.....y
......
......
bbrgg.
~~~~~~
ggr...
......
......
......
......
......
......
......""".toField

  check fieldC.connection2Vertical ==
    """
[クロスかいてん]
.....y
.....y
......
......
..r...
..r...
......
......
......
......
......
......
......""".toField
  check fieldW.connection2Vertical ==
    """
[すいちゅう]
.....y
.....y
......
......
..r...
~~~~~~
..r...
......
......
......
......
......
......
......""".toField

  check fieldC.connection2Horizontal ==
    """
[クロスかいてん]
...rr.
......
......
......
bb.gg.
gg....
......
......
......
......
......
......
......""".toField
  check fieldW.connection2Horizontal ==
    """
[すいちゅう]
...rr.
......
......
......
bb.gg.
~~~~~~
gg....
......
......
......
......
......
......
......""".toField

# ------------------------------------------------
# Connect - 3
# ------------------------------------------------

block: # connection3, connection3Vertical, connection3Horizontal, connection3LShape
  let
    fieldT =
      """
[通]
bbbrry
yggbgy
ygbbgg
yrbyyy
bbrggy
grrbbb
......
......
......
......
.....h
.....h
ooo..h""".toField
    fieldW =
      """
[すいちゅう]
bbbrry
yggbgy
ygbbgg
yrbyyy
bbrggy
~~~~~~
grrbbb
......
......
......
......
.....h
.....h
ooo..h""".toField

  check fieldT.connection3 ==
    """
[通]
bbb...
ygg.g.
yg..gg
y.....
..r...
.rrbbb
......
......
......
......
......
......
......""".toField
  check fieldW.connection3 ==
    """
[すいちゅう]
bbb...
ygg.g.
yg..gg
y.....
..r...
~~~~~~
.rrbbb
......
......
......
......
......
......
......""".toField

  check fieldT.connection3Vertical ==
    """
[通]
......
y.....
y.....
y.....
......
......
......
......
......
......
......
......
......""".toField
  check fieldW.connection3Vertical ==
    """
[すいちゅう]
......
y.....
y.....
y.....
......
~~~~~~
......
......
......
......
......
......
......
......""".toField

  check fieldT.connection3Horizontal ==
    """
[通]
bbb...
......
......
......
......
...bbb
......
......
......
......
......
......
......""".toField
  check fieldW.connection3Horizontal ==
    """
[すいちゅう]
bbb...
......
......
......
......
~~~~~~
...bbb
......
......
......
......
......
......
......""".toField

  check fieldT.connection3LShape ==
    """
[通]
......
.gg.g.
.g..gg
......
..r...
.rr...
......
......
......
......
......
......
......""".toField
  check fieldW.connection3LShape ==
    """
[すいちゅう]
......
.gg.g.
.g..gg
......
..r...
~~~~~~
.rr...
......
......
......
......
......
......
......""".toField

# ------------------------------------------------
# Shift
# ------------------------------------------------

block: # shiftUp, shiftedDown, shiftRight, shiftLeft
  let
    fieldS =
      """
[だいかいてん]
g.....
.y....
..p...
......
......
.....b
....r.
...o..
..h...
......
......
.....o
bg...p""".toField
    fieldW =
      """
[すいちゅう]
g.....
.y....
..p...
......
......
~~~~~~
.....b
....r.
...o..
..h...
......
......
.....o
bg...p""".toField

  check fieldS.dup(shiftUp) ==
    """
[だいかいてん]
.y....
..p...
......
......
.....b
....r.
...o..
..h...
......
......
.....o
bg...p
......""".toField
  check fieldW.dup(shiftUp) ==
    """
[すいちゅう]
.y....
..p...
......
......
.....b
~~~~~~
....r.
...o..
..h...
......
......
.....o
bg...p
......""".toField

  check fieldS.dup(shiftDown) ==
    """
[だいかいてん]
......
g.....
.y....
..p...
......
......
.....b
....r.
...o..
..h...
......
......
.....o""".toField
  check fieldW.dup(shiftDown) ==
    """
[すいちゅう]
......
g.....
.y....
..p...
......
~~~~~~
......
.....b
....r.
...o..
..h...
......
......
.....o""".toField

  check fieldS.dup(shiftRight) ==
    """
[だいかいてん]
.g....
..y...
...p..
......
......
......
.....r
....o.
...h..
......
......
......
.bg...""".toField
  check fieldW.dup(shiftRight) ==
    """
[すいちゅう]
.g....
..y...
...p..
......
......
~~~~~~
......
.....r
....o.
...h..
......
......
......
.bg...""".toField

  check fieldS.dup(shiftLeft) ==
    """
[だいかいてん]
......
y.....
.p....
......
......
....b.
...r..
..o...
.h....
......
......
....o.
g...p.""".toField
  check fieldW.dup(shiftLeft) ==
    """
[すいちゅう]
......
y.....
.p....
......
......
~~~~~~
....b.
...r..
..o...
.h....
......
......
....o.
g...p.""".toField

# ------------------------------------------------
# Flip
# ------------------------------------------------

block: # flipVertical, flipHorizontal
  let
    fieldC =
      """
[クロスかいてん]
p.....
..o...
......
.h....
......
......
......
......
......
......
......
......
......""".toField
    fieldW =
      """
[すいちゅう]
p.....
..o...
......
.h....
......
~~~~~~
......
......
......
......
......
......
......
......""".toField

  check fieldC.dup(flipVertical) ==
    """
[クロスかいてん]
......
......
......
......
......
......
......
......
......
.h....
......
..o...
p.....""".toField
  check fieldW.dup(flipVertical) ==
    """
[すいちゅう]
......
......
......
......
......
~~~~~~
......
......
......
......
.h....
......
..o...
p.....""".toField

  check fieldC.dup(flipHorizontal) ==
    """
[クロスかいてん]
.....p
...o..
......
....h.
......
......
......
......
......
......
......
......
......""".toField
  check fieldW.dup(flipHorizontal) ==
    """
[すいちゅう]
.....p
...o..
......
....h.
......
~~~~~~
......
......
......
......
......
......
......
......""".toField

# ------------------------------------------------
# Rotate
# ------------------------------------------------

block: # rotate, crossRotate
  let
    fieldT =
      """
[通]
p.....
..o...
......
...h..
......
......
......
......
......
......
......
......
....b.""".toField
    fieldW =
      """
[すいちゅう]
p.....
..o...
......
...h..
......
~~~~~~
......
......
......
......
......
......
......
....b.""".toField

  check fieldT.dup(rotate) ==
    """
[通]
......
.b....
......
......
......
......
......
......
......
......
..h...
......
...o..""".toField
  check fieldW.dup(rotate) ==
    """
[すいちゅう]
......
.b....
......
......
......
~~~~~~
......
......
......
......
......
..h...
......
...o..""".toField

  check fieldT.dup(crossRotate) ==
    """
[通]
......
....b.
......
......
......
......
......
......
......
......
.....h
......
o.....""".toField
  check fieldW.dup(crossRotate) ==
    """
[すいちゅう]
......
....b.
......
......
......
~~~~~~
......
......
......
......
......
.....h
......
o.....""".toField

# ------------------------------------------------
# Pop
# ------------------------------------------------

block: # pop, canPop
  var
    fieldS =
      """
[だいかいてん]
yo...g
yo..gg
yo...g
yy..oo
oo..oo
....rr
.r....
pp..h.
.p.ph.
..pph.
..phh.
.hhh..
......""".toField
    fieldW =
      """
[すいちゅう]
yo...g
yo..gg
yo...g
yy..oo
oo..oo
~~~~~~
....rr
.r....
pp..h.
.p.ph.
..pph.
..phh.
.hhh..
......""".toField

  check fieldS.canPop
  check fieldW.canPop

  let
    resultS = fieldS.pop
    resultW = fieldW.pop

    yellow =
      """
......
x.....
x.....
xx....
......
......
......
......
......
......
......
......
......""".toBinaryField
    purple =
      """
......
......
......
......
......
......
......
......
...x..
..xx..
..x...
......
......""".toBinaryField
    hard =
      """
......
......
......
......
......
......
......
......
......
......
...x..
......
......""".toBinaryField
    hardToGarbage =
      """
......
......
......
......
......
......
......
......
....x.
....x.
......
..x...
......""".toBinaryField
    garbage =
      """
......
.x....
.x....
......
xx....
......
......
......
......
......
......
......
......""".toBinaryField
    zero = BinaryField.init
    answer = PopResult.init(
      zero, zero, zero, yellow, purple, hard, hardToGarbage, garbage, yellow + purple
    )

  check resultS == answer
  check resultW == answer

  check fieldS ==
    """
[だいかいてん]
yo...g
....gg
.....g
....oo
....oo
....rr
.r....
pp..h.
.p..o.
....o.
....h.
.hoh..
......""".toField
  check fieldW ==
    """
[すいちゅう]
yo...g
....gg
.....g
....oo
....oo
~~~~~~
....rr
.r....
pp..h.
.p..o.
....o.
....h.
.hoh..
......""".toField

  check not fieldS.canPop
  check not fieldW.canPop

# ------------------------------------------------
# Place
# ------------------------------------------------

block: # place
  block:
    var field =
      """
[クロスかいてん]
.....o
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
...hoo""".toField

    check field.dup(place(_, PurplePurple, Placement.None)) == field

    field.place RedGreen, Right0
    check field ==
      """
[クロスかいてん]
.....o
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
rg.hoo""".toField

    field.place BlueYellow, Down1
    check field ==
      """
[クロスかいてん]
.....o
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
.b..oo
.y..oo
rg.hoo""".toField

    field.place PurpleRed, Left3
    check field ==
      """
[クロスかいてん]
.....o
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
.b..oo
.y.poo
rgrhoo""".toField

    field.place GreenBlue, Up4
    check field ==
      """
[クロスかいてん]
....go
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
.b..oo
.y.poo
rgrhoo""".toField

    field.place YellowPurple, Down5
    check field ==
      """
[クロスかいてん]
....go
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
....oo
.b..oo
.y.poo
rgrhoo""".toField

  block:
    var field =
      """
[すいちゅう]
......
......
......
......
......
~~~~~~
....h.
....o.
....o.
....o.
....o.
....o.
......
......""".toField

    check field.dup(place(_, PurplePurple, Placement.None)) == field

    field.place BlueYellow, Left4
    check field ==
      """
[すいちゅう]
......
......
......
......
......
~~~~~~
...yb.
....h.
....o.
....o.
....o.
....o.
....o.
......""".toField

    field.place PurpleRed, Down4
    check field ==
      """
[すいちゅう]
......
......
......
......
....p.
~~~~~~
...yr.
....b.
....h.
....o.
....o.
....o.
....o.
....o.""".toField

# ------------------------------------------------
# Drop Garbages
# ------------------------------------------------

block: # dropGarbages
  block:
    let field =
      """
[通]
....by
....by
..rgby
..rgby
..rgby
..rgby
..rgby
..rgby
..rgby
..rgby
..rgby
..rgby
..rgby""".toField

    check field.dup(dropGarbages(_, [Col0: 0, 2, 0, 3, 0, 4], false)) ==
      """
[通]
...oby
...oby
..rgby
..rgby
..rgby
..rgby
..rgby
..rgby
..rgby
..rgby
..rgby
.orgby
.orgby""".toField

  block:
    let field =
      """
[すいちゅう]
......
......
......
......
......
~~~~~~
..pybg
..pybg
....bg
....bg
......
......
......
......""".toField

    check field.dup(dropGarbages(_, [Col0: 0, 2, 0, 3, 5, 20], true)) ==
      """
[すいちゅう]
.....h
.....h
.....h
.....h
....hh
~~~~~~
.hphhh
.hphhh
...hhh
...yhh
...ybg
....bg
....bg
....bg""".toField

  block:
    let field =
      """
[すいちゅう]
....pr
....pr
....pr
..bypr
..bypr
~~~~~~
rgbypr
rgbypr
rgbypr
rgbypr
hhhhhh
rgbypr
oooooo
rgbypr""".toField

    check field.dup(dropGarbages(_, [Col0: 0, 1, 0, 1, 0, 10], false)) ==
      """
[すいちゅう]
....pr
....pr
...opr
..bypr
.obypr
~~~~~~
rgbypr
rgbypr
rgbypr
rgbypr
hhhhhh
rgbypr
oooooo
rgbypr""".toField

# ------------------------------------------------
# Apply
# ------------------------------------------------

block: # apply
  let
    pair = RedGreen
    plcmt = Left3
    counts = [Col0: 1, 2, 3, 4, 5, 6]
    dropHard = false

    step1 = Step.init(pair, plcmt)
    step2 = Step.init(counts, dropHard)
    step3 = Step.init(cross = true)
    step4 = Step.init(cross = false)

  check Field.init.dup(apply(_, step1)) == Field.init.dup(place(_, pair, plcmt))
  check Field.init(Rule.Water).dup(apply(_, step2)) ==
    Field.init(Rule.Water).dup(dropGarbages(counts, dropHard))

  let field = Field.init(Spinner).dup(apply(_, step2))
  check field.dup(apply(_, step3)) == field.dup(crossRotate)
  check field.dup(apply(_, step4)) == field.dup(rotate)

# ------------------------------------------------
# Settle
# ------------------------------------------------

block: # settle, isSettled
  block:
    var field =
      """
[クロスかいてん]
oo..o.
oo....
oo....
o.....
o.....
oo....
oo....
oo....
o.o...
oooh..
ooo...
ooo...
o.oo..""".toField

    check not field.isSettled

    field.settle

    check field ==
      """
[クロスかいてん]
o.....
o.....
o.....
o.....
oo....
oo....
oo....
oo....
ooo...
ooo...
ooo...
oooh..
ooooo.""".toField

    check field.isSettled

  block:
    var field =
      """
[すいちゅう]
....o.
....o.
...oo.
..h...
......
~~~~~~
o...o.
oh.oo.
......
.o.oo.
....o.
.o..o.
......
....o.""".toField

    check not field.isSettled

    field.settle

    check field ==
      """
[すいちゅう]
......
......
......
......
....o.
~~~~~~
ohhoo.
oo.oo.
.o.oo.
....o.
....o.
....o.
....o.
....o.""".toField

    check field.isSettled

# ------------------------------------------------
# Move
# ------------------------------------------------

block: # move
  block:
    let
      fieldBefore =
        """
[通]
....g.
....g.
....pg
....rg
....gr
....go
....gp
....bg
....bp
...bgp
...bgr
...orb
...gbb""".toField
      fieldAfter =
        """
[通]
......
......
......
......
......
......
......
......
......
......
.....r
.....b
...gbb""".toField

      pair = RedBlue
      plcmt = Down3

      chainCount = 3
      popCounts = [Cell.None: 0, 0, 2, 4, 10, 5, 0, 4]
      hardToGarbageCount = 0
      detailHardToGarbageCount = @[0, 0, 0]

      garbagesCount = [Col0: 0, 1, 2, 0, 2, 1]

      detailArray1: array[Cell, int] = [0, 0, 1, 0, 0, 5, 0, 0]
      detailArray2: array[Cell, int] = [0, 0, 0, 0, 10, 0, 0, 0]
      detailArray3: array[Cell, int] = [0, 0, 1, 4, 0, 0, 0, 4]
      detailPopCounts = @[detailArray1, detailArray2, detailArray3]

      fullArray1: array[Cell, seq[int]] = [@[], @[], @[], @[], @[], @[5], @[], @[]]
      fullArray2: array[Cell, seq[int]] = [@[], @[], @[], @[], @[4, 6], @[], @[], @[]]
      fullArray3: array[Cell, seq[int]] = [@[], @[], @[], @[4], @[], @[], @[], @[4]]
      fullPopCounts = @[fullArray1, fullArray2, fullArray3]

    block: # calc connection
      var field2 = fieldBefore
      check field2.move(Step.init(pair, plcmt)) ==
        MoveResult.init(
          chainCount, popCounts, hardToGarbageCount, detailPopCounts,
          detailHardToGarbageCount, fullPopCounts,
        )
      check field2 == fieldAfter

    block: # not calcConnection
      var field2 = fieldBefore
      check field2.move(pair, plcmt, false) ==
        MoveResult.init(
          chainCount, popCounts, hardToGarbageCount, detailPopCounts,
          detailHardToGarbageCount,
        )
      check field2 == fieldAfter

    block: # drop garbage
      var field2 = fieldBefore
      check field2.move(garbagesCount, false, false) ==
        MoveResult.init(0, Cell.initArrayWith 0, 0, @[], @[])
      check field2 ==
        """
[通]
....g.
....go
....pg
....rg
....gr
....go
....gp
....bg
....bp
...bgp
...bgr
..oorb
.oogbb""".toField

    block: # drop hard
      var field2 = fieldBefore
      check field2.move(Step.init(garbagesCount, true), false) ==
        MoveResult.init(0, Cell.initArrayWith 0, 0, @[], @[])
      check field2 ==
        """
[通]
....g.
....gh
....pg
....rg
....gr
....go
....gp
....bg
....bp
...bgp
...bgr
..horb
.hhgbb""".toField

    block: # rotate
      let
        fieldBefore2 =
          """
[通]
......
......
......
......
......
......
......
......
......
..r...
.ro...
.ro...
.roo..""".toField
        fieldAfter2 =
          """
[通]
......
......
......
......
......
......
......
......
......
......
......
......
...o..""".toField
      var field2 = fieldBefore2
      let popCounts: array[Cell, int] = [0, 0, 3, 4, 0, 0, 0, 0]
      check field2.move(Step.init(cross = false), false) ==
        MoveResult.init(1, popCounts, 0, @[popCounts], @[0])
      check field2 == fieldAfter2

# ------------------------------------------------
# Field <-> array
# ------------------------------------------------

block: # toArray, toField
  let
    fieldS =
      """
[だいかいてん]
r.....
.g....
..b...
...y..
....p.
.....o
....h.
......
......
......
......
......
......""".toField
    fieldW =
      """
[すいちゅう]
r.....
.g....
..b...
...y..
....p.
~~~~~~
.....o
....h.
......
......
......
......
......
......""".toField

    arrayS = fieldS.toArray
    arrayW = fieldW.toArray

    arrayAnswer = [
      [Red, None, None, None, None, None],
      [None, Green, None, None, None, None],
      [None, None, Blue, None, None, None],
      [None, None, None, Yellow, None, None],
      [None, None, None, None, Purple, None],
      [None, None, None, None, None, Garbage],
      [None, None, None, None, Hard, None],
      [None, None, None, None, None, None],
      [None, None, None, None, None, None],
      [None, None, None, None, None, None],
      [None, None, None, None, None, None],
      [None, None, None, None, None, None],
      [None, None, None, None, None, None],
    ]

  check arrayS == arrayAnswer
  check arrayW == arrayAnswer

  check arrayS.toField(Spinner) == fieldS
  check arrayW.toField(Rule.Water) == fieldW

# ------------------------------------------------
# Field <-> string
# ------------------------------------------------

block: # `$`, parseTsuField, parseWaterField
  let
    strC =
      """
[クロスかいてん]
r.....
.g....
..b...
...y..
....p.
.....o
....h.
......
......
......
......
......
......"""
    strW =
      """
[すいちゅう]
r.....
.g....
..b...
...y..
....p.
~~~~~~
.....o
....h.
......
......
......
......
......
......"""

    fieldC = strC.toField
    fieldW = strW.toField

  check $fieldC == strC
  check $fieldW == strW

  check strC.parseField == Pon2Result[Field].ok fieldC
  check strW.parseField == Pon2Result[Field].ok fieldW

# ------------------------------------------------
# Field <-> URI
# ------------------------------------------------

block: # toUriQuery, parseTsuField, parseWaterField
  let
    fieldT =
      """
[通]
......
......
......
......
......
r.....
.g....
..b...
...y..
....p.
.....o
....h.
......""".toField
    fieldW =
      """
[すいちゅう]
......
......
......
......
r.....
~~~~~~
.g....
..b...
...y..
....p.
.....o
....h.
......
......""".toField

  block: # Pon2
    let
      queryTResult = fieldT.toUriQuery Pon2
      queryWResult = fieldW.toUriQuery Pon2

    check queryTResult ==
      Pon2Result[string].ok "0_r......g......b......y......p......o....h......."
    check queryWResult ==
      Pon2Result[string].ok "3_r.....~.g......b......y......p......o....h"

    let
      queryT = queryTResult.unsafeValue
      queryW = queryWResult.unsafeValue

    check queryT.parseField(Pon2) == Pon2Result[Field].ok fieldT
    check queryW.parseField(Pon2) == Pon2Result[Field].ok fieldW

  block: # IshikawaPuyo, Ips
    for fqdn in [IshikawaPuyo, Ips]:
      let
        queryTResult = fieldT.toUriQuery fqdn
        queryWResult = fieldW.toUriQuery fqdn

      check queryTResult == Pon2Result[string].ok "~1.02.003.0004.00005.00000600009."
      check queryWResult.isErr

      let queryT = queryTResult.unsafeValue

      check queryT.parseField(fqdn) == Pon2Result[Field].ok fieldT

  block: # IshikawaPuyo, Ips (not tilde)
    let field =
      """
[通]
......
......
......
......
......
......
......
......
......
......
......
......
.r..g.""".toField

    for fqdn in [IshikawaPuyo, Ips]:
      let queryResult = field.toUriQuery(fqdn)
      check queryResult == Pon2Result[string].ok "10g"
      check queryResult.unsafeValue.parseField(fqdn) == Pon2Result[Field].ok field

  block: # empty field
    check Field.init.toUriQuery(Pon2) == Pon2Result[string].ok "0_"
    check Field.init.toUriQuery(IshikawaPuyo) == Pon2Result[string].ok ""
    check Field.init.toUriQuery(Ips) == Pon2Result[string].ok ""

    check Field.init(Spinner).toUriQuery(Pon2) == Pon2Result[string].ok "1_"
    check Field.init(CrossSpinner).toUriQuery(Pon2) == Pon2Result[string].ok "2_"
    check Field.init(Rule.Water).toUriQuery(Pon2) == Pon2Result[string].ok "3_~"

    check Field.init(Spinner).toUriQuery(IshikawaPuyo).isErr
    check Field.init(CrossSpinner).toUriQuery(IshikawaPuyo).isErr
    check Field.init(Rule.Water).toUriQuery(IshikawaPuyo).isErr

  block: # empty query
    check "".parseField(Pon2) == Pon2Result[Field].ok Field.init

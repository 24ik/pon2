{.experimental: "strictDefs".}
{.experimental: "strictFuncs".}
{.experimental: "views".}

import std/[sequtils, strutils, sugar, unittest]
import ../../src/pon2/private/[results2]
import ../../src/pon2/private/core/field/binary/[common]
import ../../src/pon2/core/[cell, common]

proc toBinField(str: string): BinField =
  ## Returns the binary field converted from the string representation.
  let strs = str.split "\n"
  require strs.len == Height
  require strs.allIt it.len == Width

  var arr {.noinit.}: array[Row, array[Col, bool]]
  for row in Row:
    for col in Col:
      arr[row][col] = strs[row.ord][col.ord] == 'x'

  arr.toBinField

proc main*() =
  # ------------------------------------------------
  # Constructor
  # ------------------------------------------------

  # initZero
  block:
    check BinField.initZero ==
      """
......
......
......
......
......
......
......
......
......
......
......
......
......""".toBinField

  # initOne
  block:
    check (BinField.initOne - BinField.initOne.keptValid).shiftedDownRaw ==
      """
xxxxxx
......
......
......
......
......
......
......
......
......
......
......
......""".toBinField

  # initFloor
  block:
    check BinField.initFloor ==
      """
......
......
......
......
......
......
......
......
......
......
......
......
xxxxxx""".toBinField.shiftedDownRaw

  # initLowerAir (hard-coded)
  block:
    check BinField.initLowerAir ==
      """
......
......
......
......
xxxxxx
......
......
......
......
......
......
......
......""".toBinField

  # initUpperWater (hard-coded)
  block:
    check BinField.initUpperWater ==
      """
......
......
......
......
......
xxxxxx
......
......
......
......
......
......
......""".toBinField

  # ------------------------------------------------
  # Operator
  # ------------------------------------------------

  # `+`, `-`, `*`, `xor`, `+=`, `-=`, `*=`, sum, prod
  block:
    let
      f1 =
        """
xxxxxx
xxxxx.
xxxx..
xxx...
xx....
x.....
......
......
......
......
......
......
......""".toBinField
      f2 =
        """
x.....
xx....
xxx...
xxxx..
xxxxx.
xxxxxx
......
......
......
......
......
......
......""".toBinField
      fSum =
        """
xxxxxx
xxxxx.
xxxx..
xxxx..
xxxxx.
xxxxxx
......
......
......
......
......
......
......""".toBinField
      fDiff =
        """
.xxxxx
..xxx.
...x..
......
......
......
......
......
......
......
......
......
......""".toBinField
      fProd =
        """
x.....
xx....
xxx...
xxx...
xx....
x.....
......
......
......
......
......
......
......""".toBinField
      fXor =
        """
.xxxxx
..xxx.
...x..
...x..
..xxx.
.xxxxx
......
......
......
......
......
......
......""".toBinField

    check f1 + f2 == fSum
    check f1 - f2 == fDiff
    check f1 * f2 == fProd
    check (f1 xor f2) == fXor

    var f3 = f1
    f3 += f1
    check f3 == fSum

    f3 = f1
    f3 -= f1
    check f3 == fDiff

    f3 = f1
    f3 *= f1
    check f3 == fProd

    check sum(f1, f2, fProd) == f1 + f2 + fProd
    check sum(f1, f2, fProd, fDiff) == f1 + f2 + fProd + fDiff
    check sum(f1, f2, fProd, fDiff, fXor) == f1 + f2 + fProd + fDiff + fXor
    check sum(f1, f2, fProd, fDiff, fXor, f3) == f1 + f2 + fProd + fDiff + fXor + f3
    check sum(f1, f2, fProd, fDiff, fXor, f3, BinField.initZero()) ==
      f1 + f2 + fProd + fDiff + fXor + f3 + BinField.initZero()
    check sum(f1, f2, fProd, fDiff, fXor, f3, BinField.initZero(), BinField.initFloor()) ==
      f1 + f2 + fProd + fDiff + fXor + f3 + BinField.initZero() + BinField.initFloor()

    check prod(f1, f2, fXor) == f1 * f2 * fXor

  # ------------------------------------------------
  # Keep
  # ------------------------------------------------

  # kept, keptValid, keptVisible, keptAir, keepValid
  block:
    let field =
      """
x..x..
.x..x.
..x..x
x..x..
.x..x.
..x..x
......
......
......
......
......
......
......""".toBinField

    check field.kept(Row1) ==
      """
......
.x..x.
......
......
......
......
......
......
......
......
......
......
......""".toBinField
    check field.kept(Col5) ==
      """
......
......
.....x
......
......
.....x
......
......
......
......
......
......
......""".toBinField
    check BinField.initOne.keptValid ==
      """
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx""".toBinField
    check field.keptVisible ==
      """
......
.x..x.
..x..x
x..x..
.x..x.
..x..x
......
......
......
......
......
......
......""".toBinField
    check field.keptAir ==
      """
x..x..
.x..x.
..x..x
x..x..
.x..x.
......
......
......
......
......
......
......
......""".toBinField

    check BinField.initOne.dup(keepValid) == BinField.initOne.keptValid

  # ------------------------------------------------
  # Clear
  # ------------------------------------------------

  # clear
  block:
    check BinField.initOne.dup(clear) == BinField.initZero

    var field =
      """
x.....
.x....
..x...
...x..
....x.
.....x
......
......
......
......
......
......
......""".toBinField
    field.clear Col2
    check field ==
      """
x.....
.x....
......
...x..
....x.
.....x
......
......
......
......
......
......
......""".toBinField

  # ------------------------------------------------
  # Population Count
  # ------------------------------------------------

  # cntOne
  block:
    check BinField.initOne.cntOne == 128
    check BinField.initOne.keptValid.cntOne == Height * Width
    check BinField.initZero.cntOne == 0
    check BinField.initFloor.cntOne == Width

  # ------------------------------------------------
  # Shift
  # ------------------------------------------------

  # shiftedUpRaw, shiftedDownRaw, shiftedRightRow, shiftedLeftRow,
  # shiftUpRaw, shiftDownRaw, shiftRightRaw, shiftLeftRow
  block:
    let field =
      """
......
......
......
......
...x..
..x...
......
......
......
......
......
......
......""".toBinField

    check field.shiftedUpRaw ==
      """
......
......
......
...x..
..x...
......
......
......
......
......
......
......
......""".toBinField
    check field.shiftedDownRaw ==
      """
......
......
......
......
......
...x..
..x...
......
......
......
......
......
......""".toBinField
    check field.shiftedRightRaw ==
      """
......
......
......
......
....x.
...x..
......
......
......
......
......
......
......""".toBinField
    check field.shiftedDownRaw ==
      """
......
......
......
......
..x...
.x....
......
......
......
......
......
......
......""".toBinField

    check field.dup(shiftUpRaw) == field.shiftedUpRaw
    check field.dup(shiftDownRaw) == field.shiftedDownRaw
    check field.dup(shiftRightRaw) == field.shiftedRightRaw
    check field.dup(shiftLeftRaw) == field.shiftedLeftRaw

  # ------------------------------------------------
  # Flip
  # ------------------------------------------------

  # flippedV, flippedH, flipV, flipH
  block:
    let field =
      """
......
......
......
......
...x..
..x...
......
......
......
......
......
......
......""".toBinField

    check field.flippedV ==
      """
......
......
......
......
......
......
......
..x...
...x..
......
......
......
......""".toBinField
    check field.flippedH ==
      """
......
......
......
......
..x...
...x..
......
......
......
......
......
......
......""".toBinField

    check field.dup(flipV) == field.flippedV
    check field.dup(flipH) == field.flippedH

{.push raises: [].}
{.experimental: "strictDefs".}
{.experimental: "strictFuncs".}
{.experimental: "views".}

import std/[sugar, unittest]
import ../../src/pon2/private/[assign, strutils]
import ../../src/pon2/private/core/[binaryfield]
import ../../src/pon2/core/[behaviour, common, placement]

proc toBinaryField(str: string): BinaryField =
  ## Returns the binary field converted from the string representation.
  let strs = str.split "\n"

  var arr {.noinit.}: array[Row, array[Col, bool]]
  for row in Row:
    for col in Col:
      arr[row][col].assign strs[row.ord][col.ord] == 'x'

  return arr.toBinaryField

# ------------------------------------------------
# Constructor
# ------------------------------------------------

block: # init
  check BinaryField.init ==
    """
......
......
......
......
......
......
......
......
......
......
......
......
......""".toBinaryField

block: # initOne
  check BinaryField.initOne ==
    """
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx""".toBinaryField

block: # initFloor
  check BinaryField.initFloor ==
    """
......
......
......
......
......
......
......
......
......
......
......
......
xxxxxx""".toBinaryField.shiftedDownRaw

block: # initLowerAir
  check BinaryField.initLowerAir ==
    """
......
......
......
......
xxxxxx
......
......
......
......
......
......
......
......""".toBinaryField

block: # initUpperWater
  check BinaryField.initUpperWater ==
    """
......
......
......
......
......
xxxxxx
......
......
......
......
......
......
......""".toBinaryField

# ------------------------------------------------
# Operator
# ------------------------------------------------

block: # `+`, `-`, `*`, `xor`, `+=`, `-=`, `*=`
  let
    f1 =
      """
xxxxxx
xxxxx.
xxxx..
xxx...
xx....
x.....
......
......
......
......
......
......
......""".toBinaryField
    f2 =
      """
x.....
xx....
xxx...
xxxx..
xxxxx.
xxxxxx
......
......
......
......
......
......
......""".toBinaryField
    fSum =
      """
xxxxxx
xxxxx.
xxxx..
xxxx..
xxxxx.
xxxxxx
......
......
......
......
......
......
......""".toBinaryField
    fDiff =
      """
.xxxxx
..xxx.
...x..
......
......
......
......
......
......
......
......
......
......""".toBinaryField
    fProduct =
      """
x.....
xx....
xxx...
xxx...
xx....
x.....
......
......
......
......
......
......
......""".toBinaryField
    fXor =
      """
.xxxxx
..xxx.
...x..
...x..
..xxx.
.xxxxx
......
......
......
......
......
......
......""".toBinaryField

  check f1 + f2 == fSum
  check f1 - f2 == fDiff
  check f1 * f2 == fProduct
  check (f1 xor f2) == fXor

  var f3 = f1
  f3 += f2
  check f3 == fSum

  f3 = f1
  f3 -= f2
  check f3 == fDiff

  f3 = f1
  f3 *= f2
  check f3 == fProduct

# ------------------------------------------------
# Keep
# ------------------------------------------------

block: # kept, keptValid, keptVisible, keptAir, keepValid
  let field =
    """
x..x..
.x..x.
..x..x
x..x..
.x..x.
..x..x
......
......
......
......
......
......
......""".toBinaryField

  check field.kept(Row1) ==
    """
......
.x..x.
......
......
......
......
......
......
......
......
......
......
......""".toBinaryField
  check field.kept(Col5) ==
    """
......
......
.....x
......
......
.....x
......
......
......
......
......
......
......""".toBinaryField
  check BinaryField.initOne.keptValid ==
    """
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx
xxxxxx""".toBinaryField
  check field.keptVisible ==
    """
......
.x..x.
..x..x
x..x..
.x..x.
..x..x
......
......
......
......
......
......
......""".toBinaryField
  check field.keptAir ==
    """
x..x..
.x..x.
..x..x
x..x..
.x..x.
......
......
......
......
......
......
......
......""".toBinaryField

  check BinaryField.initOne.dup(keepValid) == BinaryField.initOne.keptValid

# ------------------------------------------------
# Clear
# ------------------------------------------------

block: # clear
  check BinaryField.initOne.dup(clear) == BinaryField.init

# ------------------------------------------------
# Replace
# ------------------------------------------------

block: # replace
  var field =
    """
x.....
.x....
..x...
...x..
....x.
.....x
......
......
......
......
......
......
......""".toBinaryField
  let fieldAfter =
    """
......
......
......
......
......
......
......
.....x
....x.
...x..
..x...
.x....
x.....""".toBinaryField

  field.replace Col1, fieldAfter

  check field ==
    """
x.....
......
..x...
...x..
....x.
.....x
......
......
......
......
......
.x....
......""".toBinaryField

# ------------------------------------------------
# Population Count
# ------------------------------------------------

block: # popcnt
  check BinaryField.initOne.keptValid.popcnt == Height * Width
  check BinaryField.init.popcnt == 0
  check BinaryField.initFloor.popcnt == Width

# ------------------------------------------------
# Shift
# ------------------------------------------------

block:
  # shiftedUpRaw, shiftedDownRaw, shiftedRightRaw, shiftedLeftRaw,
  # shiftUpRaw, shiftDownRaw, shiftRightRaw, shiftLeftRaw,
  # shiftedUp, shiftedDown, shiftedRight, shiftedLeft,
  # shiftUp, shiftDown, shiftRight, shiftLeft
  let
    field =
      """
x....x
.x...x
......
......
......
......
......
......
......
......
......
.....x
xx..x.""".toBinaryField
    fieldU =
      """
.x...x
......
......
......
......
......
......
......
......
......
.....x
xx..x.
......""".toBinaryField
    fieldD =
      """
......
x....x
.x...x
......
......
......
......
......
......
......
......
......
.....x""".toBinaryField
    fieldR =
      """
.x....
..x...
......
......
......
......
......
......
......
......
......
......
.xx..x""".toBinaryField
    fieldL =
      """
....x.
x...x.
......
......
......
......
......
......
......
......
......
....x.
x..x..""".toBinaryField

  check field.shiftedUpRaw.keptValid == fieldU
  check field.shiftedDownRaw.keptValid == fieldD
  check field.shiftedRightRaw.keptValid == fieldR
  check field.shiftedLeftRaw.keptValid == fieldL

  check field.dup(shiftUpRaw) == field.shiftedUpRaw
  check field.dup(shiftDownRaw) == field.shiftedDownRaw
  check field.dup(shiftRightRaw) == field.shiftedRightRaw
  check field.dup(shiftLeftRaw) == field.shiftedLeftRaw

  check field.shiftedUp == fieldU
  check field.shiftedDown == fieldD
  check field.shiftedRight == fieldR
  check field.shiftedLeft == fieldL

  check field.dup(shiftUp) == field.shiftedUp
  check field.dup(shiftDown) == field.shiftedDown
  check field.dup(shiftRight) == field.shiftedRight
  check field.dup(shiftLeft) == field.shiftedLeft

# ------------------------------------------------
# Flip
# ------------------------------------------------

block: # flipVertical, flipHorizontal
  let
    field =
      """
......
......
......
......
...x..
..x...
......
......
......
......
......
......
......""".toBinaryField
    fieldV =
      """
......
......
......
......
......
......
......
..x...
...x..
......
......
......
......""".toBinaryField
    fieldH =
      """
......
......
......
......
..x...
...x..
......
......
......
......
......
......
......""".toBinaryField

  check field.dup(flipVertical) == fieldV
  check field.dup(flipHorizontal) == fieldH

# ------------------------------------------------
# Rotate
# ------------------------------------------------

block: # rotate, crossRotate
  let
    field =
      """
x...x.
x.....
......
.x....
......
......
......
x.....
...x..
......
......
......
....x.""".toBinaryField
    fieldR =
      """
......
.x....
......
......
......
..x...
.....x
......
......
......
....x.
......
.....x""".toBinaryField
    fieldCR =
      """
......
....x.
......
......
......
.....x
..x...
......
......
......
.x....
......
..x...""".toBinaryField

  check field.dup(rotate) == fieldR
  check field.dup(crossRotate) == fieldCR

# ------------------------------------------------
# Indexer
# ------------------------------------------------

block: # `[]`, `[]=`
  var field =
    """
......
......
.x....
......
......
......
......
......
......
......
......
......
......""".toBinaryField

  check field[Row2, Col1]
  check not field[Row1, Col2]

  let
    row = Row1
    col = Col2
  check not field[row, col]

  field[row, col] = true
  check field[row, col]

  field[row, col] = false
  check not field[row, col]

# ------------------------------------------------
# Insert / Delete
# ------------------------------------------------

block: # insert, del
  var field =
    """
......
.x....
.x....
x.....
....x.
......
......
......
......
......
......
x.....
x.....""".toBinaryField

  field.insert Row3, Col1, true, Phys.Tsu
  check field ==
    """
.x....
.x....
......
xx....
....x.
......
......
......
......
......
......
x.....
x.....""".toBinaryField

  field.insert Row4, Col1, false, Phys.Tsu
  check field ==
    """
.x....
......
.x....
x.....
....x.
......
......
......
......
......
......
x.....
x.....""".toBinaryField

  field.del Row5, Col1, Phys.Tsu
  check field ==
    """
......
.x....
......
xx....
....x.
......
......
......
......
......
......
x.....
x.....""".toBinaryField

  field.insert Row4, Col0, true, Phys.Water
  check field ==
    """
......
.x....
x.....
.x....
x...x.
......
......
......
......
......
......
x.....
x.....""".toBinaryField

  field.insert Row5, Col0, false, Phys.Water
  check field ==
    """
......
.x....
x.....
.x....
x...x.
......
......
......
......
......
......
......
x.....""".toBinaryField

  field.del Row4, Col0, Phys.Water
  check field ==
    """
......
.x....
......
xx....
....x.
......
......
......
......
......
......
......
x.....""".toBinaryField

  field.del Row5, Col0, Phys.Water
  check field ==
    """
......
.x....
......
xx....
....x.
......
......
......
......
......
......
x.....
......""".toBinaryField

# ------------------------------------------------
# Drop Garbages
# ------------------------------------------------

block: # dropGarbagesTsu
  let
    field =
      """
......
......
......
......
......
......
......
......
....x.
......
.x..x.
.....x
.xx.xx""".toBinaryField
    existField =
      """
......
......
......
......
......
......
......
......
....xx
....xx
.x..xx
.x..xx
.xx.xx""".toBinaryField

  check field.dup(dropGarbagesTsu(_, [Col0: 0, 0, 1, 1, 8, 24], existField)) ==
    """
....xx
....xx
....xx
....xx
....xx
....xx
....xx
....xx
....x.
......
.x..x.
..x..x
.xxxxx""".toBinaryField

block: # dropGarbagesWater
  block: # test1
    var
      field =
        """
......
......
......
......
......
.x.xx.
.....x
.x.xx.
.....x
....x.
......
......
......""".toBinaryField
      other1 =
        """
......
......
......
......
......
.....x
.x.xx.
.....x
....x.
.....x
......
......
......""".toBinaryField
      other2 = BinaryField.init

    dropGarbagesWater(
      field, other1, other2, [Col0: 0, 0, 1, 1, 5, 24], field + other1 + other2
    )

    check field ==
      """
.....x
.....x
.....x
....xx
....xx
.xxxxx
...xxx
.x..xx
...xx.
.....x
....x.
.....x
....x.""".toBinaryField
    check other1 ==
      """
......
......
......
......
......
......
.x....
...x..
.....x
....x.
.....x
....x.
.....x""".toBinaryField
    check other2 == BinaryField.init

  block: # test2 (full water)
    var
      field =
        """
....x.
.....x
....x.
..x..x
...xx.
x.x..x
.x.xx.
x.x..x
.x.xx.
x.x..x
.x.xx.
x.x..x
.x.xx.""".toBinaryField
      other1 =
        """
.....x
....x.
.....x
...xx.
..x..x
.x.xx.
x.x..x
.x.xx.
x.x..x
.x.xx.
x.x..x
.x.xx.
x.x..x""".toBinaryField
      other2 = BinaryField.init

    dropGarbagesWater(
      field, other1, other2, [Col0: 0, 1, 0, 2, 0, 24], field + other1 + other2
    )

    check field ==
      """
....x.
...x.x
...xx.
..x..x
.x.xx.
x.x..x
.x.xx.
x.x..x
.x.xx.
x.x..x
.x.xx.
x.x..x
.x.xx.""".toBinaryField
    check other1 ==
      """
.....x
....x.
.....x
...xx.
..x..x
.x.xx.
x.x..x
.x.xx.
x.x..x
.x.xx.
x.x..x
.x.xx.
x.x..x""".toBinaryField
    check other2 == BinaryField.init

# ------------------------------------------------
# Settle
# ------------------------------------------------

block: # settleTsu, settleWater, areSettledTsu, areSettledWater
  let
    field1 =
      """
xx....
.xx...
...xx.
.x..x.
xxx...
.xxx..
.x.xx.
x..xx.
xx..x.
.x.xx.
...x..
.x.x..
.x.xx.""".toBinaryField
    field2 =
      """
......
......
.x....
x..x..
......
......
......
.x....
..xx..
......
.x..x.
....x.
x.....""".toBinaryField
    field3 = BinaryField.init

  block: # Tsu
    var
      f1 = field1
      f2 = field2
      f3 = field3

    check not areSettledTsu(f1, f2, f3, f1 + f2 + f3)
    settleTsu(f1, f2, f3, f1 + f2 + f3)
    check areSettledTsu(f1, f2, f3, f1 + f2 + f3)

    check f1 ==
      """
.x....
.x....
......
.x.x..
.x..x.
.x.xx.
.x.xx.
x..xx.
.x..x.
xxxxx.
x.xx..
xxxx..
.x.xx.""".toBinaryField

    check f2 ==
      """
......
......
.x....
......
...x..
......
......
.x....
x..x..
......
.x..x.
....x.
x.x...""".toBinaryField

    check f3 == BinaryField.init

  block: # Water
    var
      f1 = field1
      f2 = field2
      f3 = field3

    check not areSettledWater(f1, f2, f3, f1 + f2 + f3)
    settleWater(f1, f2, f3, f1 + f2 + f3)
    check areSettledWater(f1, f2, f3, f1 + f2 + f3)

    check f1 ==
      """
.x....
.x....
......
.x.x..
.x..x.
xxxxx.
.xxxx.
x.xxx.
xx..x.
xx.xx.
...x..
.x.x..
.x.xx.""".toBinaryField

    check f2 ==
      """
......
......
.x....
......
...x..
......
x.....
.x....
..xx..
......
xx..x.
....x.
......""".toBinaryField

    check f3 == BinaryField.init

# ------------------------------------------------
# Property
# ------------------------------------------------

block: # isDead
  block: # Tsu
    var field = BinaryField.initOne.keptValid
    check field.isDead Tsu

    field[Row1, Col2] = false
    check not field.isDead Tsu

  block: # Water
    var field = BinaryField.init
    check not field.isDead Water

    field[Row4, Col5] = true
    check field.isDead Water

# ------------------------------------------------
# Placement
# ------------------------------------------------

block: # invalidPlacements, validPlacements, validDoublePlacements
  block:
    let field = BinaryField.init
    check field.invalidPlacements == {Placement.None}
    check field.validPlacements == ActualPlacements
    check field.validDoublePlacements == DoublePlacements

  block:
    let field =
      """
......
.x....
......
......
......
......
......
......
......
......
......
......
......""".toBinaryField
    check field.invalidPlacements ==
      {Placement.None, Up0, Right0, Down0, Up1, Right1, Down1, Left1, Left2}

  block:
    let field =
      """
......
.x....
.....x
......
......
......
......
......
......
......
......
......
......""".toBinaryField
    check field.invalidPlacements == {Placement.None, Down1}

  block:
    let field =
      """
......
.x.x..
......
......
......
......
......
......
......
......
......
......
......""".toBinaryField
    check field.invalidPlacements == {Placement.None, Down1, Down3}

  block:
    let field =
      """
.x....
.x.x..
......
......
......
......
......
......
......
......
......
......
......""".toBinaryField
    check field.invalidPlacements ==
      {Placement.None, Up0, Right0, Down0, Up1, Right1, Down1, Left1, Left2, Down3}

  block:
    let field =
      """
....x.
.x.x..
..x...
......
......
......
......
......
......
......
......
......
......""".toBinaryField
    check field.invalidPlacements ==
      {
        Placement.None, Down1, Right3, Down3, Up4, Right4, Down4, Left4, Up5, Down5,
        Left5,
      }

# ------------------------------------------------
# Pop
# ------------------------------------------------

block: # extractedPop, canPop
  let field =
    """
x.....
xxx.xx
.....x
x..x..
xxx..x
.....x
..xx.x
xx...x
xx..x.
...xx.
xxx.x.
xx....
..xxxx""".toBinaryField

  check field.extractedPop ==
    """
......
......
......
x.....
xxx..x
.....x
.....x
xx...x
xx..x.
...xx.
xxx.x.
xx....
..xxxx""".toBinaryField
  check field.canPop
  check not BinaryField.init.canPop

# ------------------------------------------------
# Connect - 2
# ------------------------------------------------

block: # connection2, connection2Vertical, connection2Horizontal
  let field =
    """
x...xx
x.....
....x.
x..x..
.x...x
.....x
xx.x..
...x..
xx.x..
.x....
...xxx
x.....
..xxxx""".toBinaryField

  check field.connection2 ==
    """
x...xx
x.....
......
......
.....x
.....x
xx....
......
......
......
......
......
......""".toBinaryField

  check field.connection2Vertical ==
    """
x.....
x.....
......
......
.....x
.....x
......
......
......
......
......
......
......""".toBinaryField

  check field.connection2Horizontal ==
    """
....xx
......
......
......
......
......
xx....
......
......
......
......
......
......""".toBinaryField

# ------------------------------------------------
# Connect - 3
# ------------------------------------------------

block: # connection3, connection3Vertical, connection3Horizontal, connection3LShape
  let field =
    """
xxx.x.
....xx
x.xx.x
x...x.
x.x..x
..xx.x
x.....
.x.xx.
xx.x..
....xx
xxx..x
....x.
xx.xxx""".toBinaryField

  check field.connection3 ==
    """
xxx...
......
x.....
x.....
x.x...
..xx..
......
.x.xx.
xx.x..
....xx
xxx..x
......
......""".toBinaryField

  check field.connection3Vertical ==
    """
......
......
x.....
x.....
x.....
......
......
......
......
......
......
......
......""".toBinaryField

  check field.connection3Horizontal ==
    """
xxx...
......
......
......
......
......
......
......
......
......
xxx...
......
......""".toBinaryField

  check field.connection3LShape ==
    """
......
......
......
......
..x...
..xx..
......
.x.xx.
xx.x..
....xx
.....x
......
......""".toBinaryField

# ------------------------------------------------
# BinaryField <-> array
# ------------------------------------------------

block: # toArray, toBinaryField
  let field =
    """
.x....
...x..
.....x
......
......
......
......
......
......
......
......
......
......""".toBinaryField

  check field.toArray.toBinaryField == field

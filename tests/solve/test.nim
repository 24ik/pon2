{.push raises: [].}
{.experimental: "strictDefs".}
{.experimental: "strictFuncs".}
{.experimental: "views".}

import std/[sets, sugar, unittest]
import ../../src/pon2/[core]
import ../../src/pon2/app/[solve]

const NonePlacementStr = ".."

func toPlacement(str: string): Placement =
  ## Returns the placement converted from the string representation.
  if str == NonePlacementStr: Placement.None else: str.parsePlacement.unsafeValue

func toSolutions(strs: varargs[string]): HashSet[Solution] =
  ## Returns the solutions converted from the string representation.
  var solutions = initHashSet[Solution]()
  for str in strs:
    let solution = collect:
      for i in countup(0, str.len - 1, 2):
        str.substr(i, i + 1).toPlacement
    solutions.incl solution

  solutions

proc solve(str: string, calcAllSolutions = true): HashSet[Solution] =
  ## Returns the solutions of Tsu Nazo Puyo.
  str.parseNazoPuyo.unsafeValue.solve(calcAllSolutions).toHashSet

block: # solve
  block: # Chain
    check """
ちょうど3連鎖するべし
======
[通]
......
......
......
......
......
......
......
......
......
.r..r.
.r.or.
.roor.
.yyoo.
------
ry|
ry|""".solve ==
      "4S3N".toSolutions

  block: # Color
    check """
ちょうど2色同時に消すべし
======
[だいかいてん]
......
......
......
......
......
......
...g..
...po.
...pg.
...pg.
...og.
.o.pp.
.gggp.
------
gp|
gp|""".solve ==
      "656S".toSolutions

  block: # Count
    check """
ぷよちょうど12個同時に消すべし
======
[クロスかいてん]
......
......
......
......
......
......
......
......
......
...r..
..rr..
rggb..
rrgbb.
------
rb|
rg|""".solve ==
      "3S32".toSolutions

  block: # Place
    check """
ぷよちょうど2箇所で同時に消すべし
======
[通]
......
......
......
......
......
......
......
......
......
......
....r.
y...y.
yyryy.
------
ry|
ry|""".solve ==
      "4S32".toSolutions

  block: # Connection
    check """
ぷよちょうど7連結で消すべし
======
[だいかいてん]
......
......
......
......
......
......
......
......
..o...
grgr..
ggrg..
rrbb..
gggbr.
------
gg|
bg|""".solve ==
      "4N54".toSolutions

  block: # AccumColor
    check """
累計ちょうど3色消すべし
======
[クロスかいてん]
......
......
......
......
......
......
......
......
......
......
......
...gbr
.bgbrr
------
bg|
rg|""".solve ==
      "3S65".toSolutions

  block: # AccumCount
    check """
ぷよ累計ちょうど18個消すべし
======
[通]
......
......
......
......
......
......
......
......
..b...
..y...
ggg...
ooo...
ooobbb
------
yy|
yg|""".solve ==
      toSolutions("1N2S", "124N")

  block: # clear
    check """
ぷよ全て消すべし
======
[だいかいてん]
......
......
......
......
......
......
......
......
......
......
......
bb.yyy
yy.bbb
------
by|
by|""".solve ==
      "433S".toSolutions

  block: # clear w/ kind
    check """
ちょうど4連鎖する&ぷよ全て消すべし
======
[クロスかいてん]
......
......
......
......
......
......
......
......
.by...
.bby..
.rry..
oobb..
oorboo
------
rb|
yb|""".solve ==
      "1S5S".toSolutions

  block: # more
    check """
ぷよ累計28個以上消すべし
======
[通]
......
......
......
......
......
......
......
.rogb.
.rrbb.
.bgrg.
.bbrr.
.rrbo.
.grbb.
------
rb|
rb|""".solve ==
      "1N1S".toSolutions

  block: # Water
    check """
ちょうど3連鎖するべし
======
[すいちゅう]
......
......
......
......
......
~~~~~~
rpor..
.pp...
..y...
..y...
..y...
......
......
......
------
ry|
rp|""".solve ==
      "322S".toSolutions

  block: # Hard
    check """
ちょうど3連鎖するべし
======
[だいかいてん]
......
......
......
......
......
......
......
......
..r...
..r...
..rg..
..gh..
..oggg
------
gg|
gr|""".solve ==
      "1N2S".toSolutions

  block: # drop garbages
    check """
ちょうど4連鎖するべし
======
[クロスかいてん]
......
......
......
......
......
......
......
......
......
.gb...
.br...
.gbry.
.gbry.
------
yg|
(0,0,0,0,1,0)
yr|""".solve ==
      "3S..4S".toSolutions

  block: # rotate
    check """
ぷよ全て消すべし
======
[だいかいてん]
.....o
.....o
....bo
....bo
....bo
...yro
...oro
...oro
...ogo
...ogo
...ogo
...oro
.yyobo
------
R
gy|""".solve ==
      "..32".toSolutions

  block: # rotate
    check """
ぷよ全て消すべし
======
[クロスかいてん]
......
......
......
......
......
......
......
......
......
......
......
b...o.
b...o.
------
bb|
C""".solve ==
      "6N..".toSolutions

  block: # initial nazopuyo is satisfied
    check """
ぷよ全て消すべし
======
[通]
......
......
......
......
......
......
......
......
......
......
......
......
......
------
rr|""".solve ==
      toSolutions()
    check """
ぷよ全て消すべし
======
[だいかいてん]
......
......
......
......
......
......
......
......
......
......
......
......
......
------
(0,0,4,0,2,0)
rr|
rr|""".solve ==
      "..4N4N".toSolutions

  block: # not supported
    check """
おじゃまぷよ2箇所以上で同時に消すべし
======
[クロスかいてん]
......
......
......
......
......
......
......
......
......
....o.
o...r.
y...y.
yyryy.
------
ry|
ry|""".solve ==
      toSolutions()

  block: # early satisfy
    check """
ぷよ全て消すべし
======
[通]
......
......
......
......
......
......
......
......
......
.r....
.rr...
.bbr..
.rrbb.
------
rr|
rb|""".solve ==
      toSolutions("1N", "5N54", "6N54")

  block: # not calcAllSolutions
    check """
ぷよ全て消すべし
======
[だいかいてん]
......
......
......
......
......
......
......
......
......
.r....
.rr...
.bbr..
.rrbb.
------
rr|
rb|""".solve(
      false
    ) <= toSolutions("1N", "5N54", "6N54")

  block: # check spawn
    check """
ちょうど13連鎖するべし
======
[通]
......
......
......
.....r
.o..gg
gg..bg
bbr.rr
byrrbr
gyybby
gbrggg
gybyby
byybyy
bggybb
------
yy|
gg|
yy|
bg|
yg|""".solve ==
      "23344N2121".toSolutions

  block: # reject mid-dead
    check """
ちょうど1連鎖するべし
======
[通]
......
....o.
..o.o.
..o.o.
..o.o.
..o.o.
..o.o.
..o.o.
..o.o.
..o.o.
..p.o.
..p.oo
..p.rr
------
rg|
rg|""".solve ==
      toSolutions("454N", "4543")

    check """
ちょうど1連鎖するべし
======
[すいちゅう]
......
......
......
......
......
~~~~~~
ror.o.
ooo.o.
ooo.o.
ooo.o.
ooo.o.
ooo.o.
ooo.o.
o.o.o.
------
rg|
rg|""".solve ==
      toSolutions("4S2N", "4S21", "4S23")

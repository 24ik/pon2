{.push raises: [].}
{.experimental: "strictDefs".}
{.experimental: "strictFuncs".}
{.experimental: "views".}

import std/[sequtils, sets, sugar, unittest]
import ../../src/pon2/[core]
import ../../src/pon2/app/[solve]

const NonePlcmtStr = ".."

func toOptPlcmt(str: string): OptPlacement =
  ## Returns the `OptPlacement` converted from the string representation.
  if str == NonePlcmtStr:
    NonePlacement
  else:
    OptPlacement.ok str.parsePlacement.unsafeValue

func toAnswers(strs: varargs[string]): HashSet[SolveAnswer] =
  ## Returns the answers converted from the string representation.
  var answers = initHashSet[SolveAnswer]()
  for str in strs:
    let answer = collect:
      for i in countup(0, str.len.pred, 2):
        str.substr(i, i.succ).toOptPlcmt
    answers.incl answer

  answers

proc tsuSolve(str: string, calcAllAnswers: static bool = true): HashSet[SolveAnswer] =
  ## Returns the answers of Tsu Nazo Puyo.
  parseNazoPuyo[TsuField](str).unsafeValue.solve(calcAllAnswers).toHashSet

proc waterSolve(str: string, calcAllAnswers: static bool = true): HashSet[SolveAnswer] =
  ## Returns the answers of Water Nazo Puyo.
  parseNazoPuyo[WaterField](str).unsafeValue.solve(calcAllAnswers).toHashSet

block: # solve
  block: # Chain
    check """
ちょうど3連鎖するべし
======
......
......
......
......
......
......
......
......
......
.r..r.
.r.or.
.roor.
.yyoo.
------
ry|
ry|""".tsuSolve ==
      "4S3N".toAnswers

  block: # Color
    check """
ちょうど2色同時に消すべし
======
......
......
......
......
......
......
...g..
...po.
...pg.
...pg.
...og.
.o.pp.
.gggp.
------
gp|
gp|""".tsuSolve ==
      "656S".toAnswers

  block: # Count
    check """
ぷよちょうど12個同時に消すべし
======
......
......
......
......
......
......
......
......
......
...r..
..rr..
rggb..
rrgbb.
------
rb|
rg|""".tsuSolve ==
      "3S32".toAnswers

  block: # Place
    check """
ぷよちょうど2箇所で同時に消すべし
======
......
......
......
......
......
......
......
......
......
......
....r.
y...y.
yyryy.
------
ry|
ry|""".tsuSolve ==
      "4S32".toAnswers

  block: # Connection
    check """
ぷよちょうど7連結で消すべし
======
......
......
......
......
......
......
......
......
..o...
grgr..
ggrg..
rrbb..
gggbr.
------
gg|
bg|""".tsuSolve ==
      "4N54".toAnswers

  block: # AccumColor
    check """
累計ちょうど3色消すべし
======
......
......
......
......
......
......
......
......
......
......
......
...gbr
.bgbrr
------
bg|
rg|""".tsuSolve ==
      "3S65".toAnswers

  block: # AccumCount
    check """
ぷよ累計ちょうど18個消すべし
======
......
......
......
......
......
......
......
......
..b...
..y...
ggg...
ooo...
ooobbb
------
yy|
yg|""".tsuSolve ==
      toAnswers("1N2S", "124N")

  block: # clear
    check """
ぷよ全て消すべし
======
......
......
......
......
......
......
......
......
......
......
......
bb.yyy
yy.bbb
------
by|
by|""".tsuSolve ==
      "433S".toAnswers

  block: # clear w/ kind
    check """
ちょうど4連鎖する&ぷよ全て消すべし
======
......
......
......
......
......
......
......
......
.by...
.bby..
.rry..
oobb..
oorboo
------
rb|
yb|""".tsuSolve ==
      "1S5S".toAnswers

  block: # more
    check """
ぷよ累計28個以上消すべし
======
......
......
......
......
......
......
......
.rogb.
.rrbb.
.bgrg.
.bbrr.
.rrbo.
.grbb.
------
rb|
rb|""".tsuSolve ==
      "1N1S".toAnswers

  block: # Water
    check """
ちょうど3連鎖するべし
======
......
......
......
......
......
~~~~~~
rpor..
.pp...
..y...
..y...
..y...
......
......
......
------
ry|
rp|""".waterSolve ==
      "322S".toAnswers

  block: # Hard
    check """
ちょうど3連鎖するべし
======
......
......
......
......
......
......
......
......
..r...
..r...
..rg..
..gh..
..oggg
------
gg|
gr|""".tsuSolve ==
      "1N2S".toAnswers

  block: # drop garbages
    check """
ちょうど4連鎖するべし
======
......
......
......
......
......
......
......
......
......
.gb...
.br...
.gbry.
.gbry.
------
yg|
(0,0,0,0,1,0)
yr|""".tsuSolve ==
      "3S..4S".toAnswers

  block: # rotate
    check """
ぷよ全て消すべし
======
.....o
.....o
....bo
....bo
....bo
...yro
...oro
...oro
...ogo
...ogo
...ogo
...oro
.yyobo
------
O
gy|""".tsuSolve ==
      "..32".toAnswers

  block: # initial nazopuyo is satisfied
    check """
ぷよ全て消すべし
======
......
......
......
......
......
......
......
......
......
......
......
......
......
------
rr|""".tsuSolve ==
      toAnswers()
    check """
ぷよ全て消すべし
======
......
......
......
......
......
......
......
......
......
......
......
......
......
------
(0,0,4,0,2,0)
rr|
rr|""".tsuSolve ==
      "..4N4N".toAnswers

  block: # not supported
    check """
おじゃまぷよ2箇所以上で同時に消すべし
======
......
......
......
......
......
......
......
......
......
....o.
o...r.
y...y.
yyryy.
------
ry|
ry|""".tsuSolve ==
      toAnswers()

  block: # early satisfy
    check """
ぷよ全て消すべし
======
......
......
......
......
......
......
......
......
......
.r....
.rr...
.bbr..
.rrbb.
------
rr|
rb|""".tsuSolve ==
      toAnswers("1N", "5N54", "6N54")

  block: # not calcAllAnswers
    check """
ぷよ全て消すべし
======
......
......
......
......
......
......
......
......
......
.r....
.rr...
.bbr..
.rrbb.
------
rr|
rb|""".tsuSolve(
      false
    ) <= toAnswers("1N", "5N54", "6N54")

  block: # check spawn
    check """
ちょうど13連鎖するべし
======
......
......
......
.....r
.o..gg
gg..bg
bbr.rr
byrrbr
gyybby
gbrggg
gybyby
byybyy
bggybb
------
yy|
gg|
yy|
bg|
yg|""".tsuSolve ==
      "23344N2121".toAnswers

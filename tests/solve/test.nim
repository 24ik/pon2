{.push raises: [].}
{.experimental: "strictDefs".}
{.experimental: "strictFuncs".}
{.experimental: "views".}

import std/[sequtils, sets, sugar, unittest]
import ../../src/pon2/[core]
import ../../src/pon2/app/[solve]

const NonePlcmtStr = ".."

func toOptPlcmt(str: string): OptPlacement =
  ## Returns the `OptPlacement` converted from the string representation.
  if str == NonePlcmtStr:
    NonePlacement
  else:
    OptPlacement.ok str.parsePlacement.expect "Invalid placement"

func toAnswers(strs: varargs[string]): HashSet[SolveAnswer] =
  ## Returns the answers converted from the string representation.
  var answers = initHashSet[SolveAnswer]()
  for str in strs:
    let answer = collect:
      for i in countup(0, str.len.pred, 2):
        str.substr(i, i.succ).toOptPlcmt
    answers.incl answer

  answers

proc tsuSolve(str: string, calcAllAnswers: static bool = true): HashSet[SolveAnswer] =
  ## Returns the answers of Tsu Nazo Puyo.

  parseNazoPuyo[TsuField](str)
  .expect("Invalid NazoPuyo")
  .solve(calcAllAnswers).toHashSet

proc waterSolve(str: string, calcAllAnswers: static bool = true): HashSet[SolveAnswer] =
  ## Returns the answers of Water Nazo Puyo.

  parseNazoPuyo[WaterField](str)
  .expect("Invalid NazoPuyo")
  .solve(calcAllAnswers).toHashSet

block: # solve
  block: # Clear
    check """
ぷよ全て消すべし
======
......
......
......
......
......
......
......
......
......
......
......
bb.yyy
yy.bbb
------
by|
by|""".tsuSolve ==
      "433S".toAnswers

  block: # AccColor
    check """
3色消すべし
======
......
......
......
......
......
......
......
......
......
......
......
...gbr
.bgbrr
------
bg|
rg|""".tsuSolve ==
      "3S65".toAnswers

  block: # AccColorMore
    check """
3色以上消すべし
======
......
......
......
......
......
......
......
......
......
......
......
..bob.
rrryyy
------
br|
by|""".tsuSolve ==
      toAnswers("4S56", "4S6S")

  block: # AccCnt
    check """
ぷよ18個消すべし
======
......
......
......
......
......
......
......
......
..b...
..y...
ggg...
ooo...
ooobbb
------
yy|
yg|""".tsuSolve ==
      toAnswers("1N2S", "124N")

  block: # AccCntMore
    check """
ぷよ28個以上消すべし
======
......
......
......
......
......
......
......
.rogb.
.rrbb.
.bgrg.
.bbrr.
.rrbo.
.grbb.
------
rb|
rb|""".tsuSolve ==
      "1N1S".toAnswers

  block: # Chain
    check """
3連鎖するべし
======
......
......
......
......
......
......
......
......
......
.r..r.
.r.or.
.roor.
.yyoo.
------
ry|
ry|""".tsuSolve ==
      "4S3N".toAnswers

  block: # ChainMore
    check """
3連鎖以上するべし
======
......
......
......
......
......
......
......
......
......
......
..o.br
.ogbrr
.ggooo
------
rb|
gb|""".tsuSolve ==
      "4312".toAnswers

  block: # ClearChain
    check """
4連鎖&ぷよ全て消すべし
======
......
......
......
......
......
......
......
......
.by...
.bby..
.rry..
oobb..
oorboo
------
rb|
yb|""".tsuSolve ==
      "1S5S".toAnswers

  block: # ClearChainMore
    check """
4連鎖以上&ぷよ全て消すべし
======
......
......
......
......
......
......
......
......
...g..
..gg..
ggppgg
pgpgpg
ppggpp
------
pg|
pg|""".tsuSolve ==
      "3N56".toAnswers

  block: # Color
    check """
2色同時に消すべし
======
......
......
......
......
......
......
...g..
...po.
...pg.
...pg.
...og.
.o.pp.
.gggp.
------
gp|
gp|""".tsuSolve ==
      "656S".toAnswers

  block: # ColorMore
    check """
2色以上同時に消すべし
======
......
......
......
......
......
......
...g..
...po.
...pg.
...pg.
...og.
.o.pp.
.gggp.
------
gp|
gp|""".tsuSolve ==
      "656S".toAnswers

  block: # Cnt
    check """
ぷよ12個同時に消すべし
======
......
......
......
......
......
......
......
......
......
...r..
..rr..
rggb..
rrgbb.
------
rb|
rg|""".tsuSolve ==
      "3S32".toAnswers

  block: # CntMore
    check """
ぷよ12個以上同時に消すべし
======
......
......
......
......
......
......
......
......
......
...r..
..rr..
rggb..
rrgbb.
------
rb|
rg|""".tsuSolve ==
      "3S32".toAnswers

  block: # Place
    check """
ぷよ2箇所同時に消すべし
======
......
......
......
......
......
......
......
......
......
......
....r.
y...y.
yyryy.
------
ry|
ry|""".tsuSolve ==
      "4S32".toAnswers

  block: # PlaceMore
    check """
ぷよ2箇所以上同時に消すべし
======
......
......
......
......
......
......
......
......
......
......
....r.
y...y.
yyryy.
------
ry|
ry|""".tsuSolve ==
      "4S32".toAnswers

  block: # Conn
    check """
ぷよ7連結で消すべし
======
......
......
......
......
......
......
......
......
..o...
grgr..
ggrg..
rrbb..
gggbr.
------
gg|
bg|""".tsuSolve ==
      "4N54".toAnswers

  block: # ConnMore
    check """
ぷよ7連結以上で消すべし
======
......
......
......
......
......
......
......
......
..o...
grgr..
ggrg..
rrbb..
gggbr.
------
gg|
bg|""".tsuSolve ==
      "4N54".toAnswers

  block: # Water
    check """
3連鎖するべし
======
......
......
......
......
......
~~~~~~
rpor..
.pp...
..y...
..y...
..y...
......
......
......
------
ry|
rp|""".waterSolve ==
      "322S".toAnswers

  block: # Hard
    check """
3連鎖するべし
======
......
......
......
......
......
......
......
......
..r...
..r...
..rg..
..gh..
..oggg
------
gg|
gr|""".tsuSolve ==
      "1N2S".toAnswers

  block: # drop garbages
    check """
4連鎖するべし
======
......
......
......
......
......
......
......
......
......
.gb...
.br...
.gbry.
.gbry.
------
yg|
(0,0,0,0,1,0)
yr|""".tsuSolve ==
      "3S..4S".toAnswers

  block: # initial nazopuyo is clear
    check """
ぷよ全て消すべし
======
......
......
......
......
......
......
......
......
......
......
......
......
......
------
rr|""".tsuSolve ==
      toAnswers()

  block: # not supported
    check """
おじゃまぷよ2箇所以上同時に消すべし
======
......
......
......
......
......
......
......
......
......
....o.
o...r.
y...y.
yyryy.
------
ry|
ry|""".tsuSolve ==
      toAnswers()

  block: # early satisfy
    check """
ぷよ全て消すべし
======
......
......
......
......
......
......
......
......
......
.r....
.rr...
.bbr..
.rrbb.
------
rr|
rb|""".tsuSolve ==
      toAnswers("1N", "5N54", "6N54")

  block: # not calcAllAnswers
    check """
ぷよ全て消すべし
======
......
......
......
......
......
......
......
......
......
.r....
.rr...
.bbr..
.rrbb.
------
rr|
rb|""".tsuSolve(
      false
    ) <= toAnswers("1N", "5N54", "6N54")

  block: # with spawn
    check """
13連鎖するべし
======
......
......
......
.....r
.o..gg
gg..bg
bbr.rr
byrrbr
gyybby
gbrggg
gybyby
byybyy
bggybb
------
yy|
gg|
yy|
bg|
yg|""".tsuSolve ==
      "23344N2121".toAnswers
